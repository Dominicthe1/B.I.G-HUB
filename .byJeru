-- Prevent old hub overlap
if getgenv().BIG_HUB_RUNNING then
    warn("Restarting hub...")
    getgenv().BIG_HUB_RUNNING = false
    task.wait(1)
end
getgenv().BIG_HUB_RUNNING = true

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer

-- Config positions
local lobbyCFrame = CFrame.new(-2500,0,2500)
local towerExitCFrame = CFrame.new(-2508.806, -348.512, 2680.211)
local trialExitCFrame = CFrame.new(-2575.984, -262.103, 1653.922)
local trialStartCFrame = CFrame.new(-2644.199, -260.904, 1649.696)
local savedPosition = nil

-- Tower / Trial Values
local towerValues = ReplicatedStorage:WaitForChild("Gamemodes"):WaitForChild("Tower")
local towerWave = towerValues:WaitForChild("Wave")
local towerOpen = towerValues:WaitForChild("Open")

local trialValues = ReplicatedStorage:WaitForChild("Gamemodes"):WaitForChild("Trial")
local trialWave = trialValues:WaitForChild("Wave")
local trialOpen = trialValues:WaitForChild("Open")

-- States
local autoTowerEnabled, autoTrialEnabled = false, false
local autoLeaveEnabled, spinEnabled = false, false
local inTower, inTrial = false, false
local waitingForExit, canAutoJoin = false, true
local leaveTowerWave, leaveTrialWave = 6, 6

-- Helper
local function getBridge()
    local remotes = ReplicatedStorage:FindFirstChild("Remotes")
    return remotes and remotes:FindFirstChild("Bridge")
end

-- Click Yes
local function clickYes()
    pcall(function()
        local confirmUI = player:WaitForChild("PlayerGui"):FindFirstChild("ConfirmUI")
        if not confirmUI then return end
        local yesButton = confirmUI.Offset.Frame.Frame.Buttons:WaitForChild("Yes")
        local clickable = yesButton:FindFirstChildWhichIsA("TextButton",true) or yesButton:FindFirstChildWhichIsA("ImageButton",true)
        if clickable then firesignal(clickable.MouseButton1Click) end
    end)
end

-- Leave Tower (Blocking)
local function leaveTower()
    if waitingForExit then return end -- Prevent stacking
    waitingForExit=true
    inTower=false
    canAutoJoin=false
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    
    print("Leaving Tower...")
    if hrp then 
        pcall(function() hrp.CFrame = towerExitCFrame end)
    end
    
    task.wait(3) -- "Exit 3sec" wait
    pcall(clickYes) -- Use pcall for safety

    task.wait(3) -- "tp 3 sec" wait
    if savedPosition and hrp then 
        pcall(function() hrp.CFrame = savedPosition end)
    end

    task.wait(1) -- Extra buffer
    canAutoJoin=true
    waitingForExit=false
    print("Leave Tower complete.")
end

-- Leave Trial (Blocking)
local function leaveTrial()
    if waitingForExit then return end -- Prevent stacking
    waitingForExit=true
    inTrial=false
    canAutoJoin=false
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    
    print("Leaving Trial...")
    if hrp then 
        pcall(function() hrp.CFrame = trialExitCFrame end)
    end
    
    task.wait(3) -- "Exit 3sec" wait
    pcall(clickYes) -- Use pcall for safety

    task.wait(3) -- "tp 3 sec" wait
    if savedPosition and hrp then 
        pcall(function() hrp.CFrame = savedPosition end)
    end

    task.wait(1) -- Extra buffer
    canAutoJoin=true
    waitingForExit=false
    print("Leave Trial complete.")
end

-- Tower & Trial auto join loop
task.spawn(function()
    while getgenv().BIG_HUB_RUNNING do -- Use the main running flag to stop the loop
        task.wait(3) -- Loop delay
        
        if waitingForExit or not canAutoJoin then continue end -- Don't do anything if we are busy

        local bridge = getBridge()
        if not bridge then continue end

        -- Priority 1: Trial
        if autoTrialEnabled and trialOpen.Value then
            if inTower then
                -- Trial is open, but we are in the tower. Force leave tower.
                print("Trial is available. Forcing exit from Tower.")
                leaveTower() -- This is a blocking call. Loop will pause here.
                -- After leaveTower() finishes, canAutoJoin will be true,
                -- and the loop will re-run. Next iteration, it will hit the 'elseif not inTrial' block.
            
            elseif not inTrial then
                -- Trial is open, we are not in tower, and not in trial. Join.
                print("Joining Trial...")
                canAutoJoin = false -- Prevent other actions
                pcall(function() bridge:FireServer("Gamemodes","Trial","Start") end)
                task.wait(3) -- "Join wait 3sec"
                pcall(function() bridge:FireServer("Gamemodes","Trial","Join") end)
                task.wait(3) -- Wait after join
                
                local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if hrp then 
                    pcall(function() hrp.CFrame = trialStartCFrame end)
                    print("Teleported to Trial start") 
                end
                inTrial=true
                canAutoJoin = true -- Ready for next action (e.g., auto-leave)
            end
        
        -- Priority 2: Tower (only if Trial is not wanted or not open)
        elseif autoTowerEnabled and not inTrial and not inTower then
            -- Not doing trial, and we want to join tower.
            print("Joining Tower...")
            canAutoJoin = false -- Prevent other actions
            if not towerOpen.Value then 
                pcall(function() bridge:FireServer("Gamemodes","Tower","Start") end)
                task.wait(3) -- "Join wait 3sec"
            end
            pcall(function() bridge:FireServer("Gamemodes","Tower","Join") end)
            task.wait(3) -- Wait after join
            
            inTower=true
            canAutoJoin = true -- Ready for next action
        end
    end
    print("Auto join loop stopped.")
end)

-- Auto Leave Listeners
towerWave:GetPropertyChangedSignal("Value"):Connect(function()
    if inTower and autoLeaveEnabled and towerWave.Value>=leaveTowerWave then
        print("Auto-leaving tower due to wave limit.")
        leaveTower() -- This will now block, which is fine.
    end
end)
trialWave:GetPropertyChangedSignal("Value"):Connect(function()
    if inTrial and autoLeaveEnabled and trialWave.Value>=leaveTrialWave then
        print("Auto-leaving trial due to wave limit.")
        leaveTrial() -- This will now block, which is fine.
    end
end)

-- Save Position
RunService.Heartbeat:Connect(function()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and not inTower and not inTrial then
        savedPosition = player.Character.HumanoidRootPart.CFrame
    end
end)

-- Stars auto-spin
task.spawn(function()
    while getgenv().BIG_HUB_RUNNING do
        task.wait()
        if spinEnabled then
            local bridge = getBridge()
            if bridge then pcall(function() bridge:FireServer("General","Star","Open") end) end
        end
    end
end)

-- Auto AFK
task.spawn(function()
    print("Anti AFK activated")
    while getgenv().BIG_HUB_RUNNING do
        task.wait(60)
        pcall(function() game:GetService("VirtualUser"):ClickButton2(Vector2.new(0,0)) end)
    end
end)

-- Rayfield GUI
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Tower Hub",
    LoadingTitle = "Tower Automation",
    LoadingSubtitle = "by B.I.G",
    Theme = "Default",
    ToggleUIKeybind = "K",
    ConfigurationSaving={Enabled=true, FileName="BIG_Hub_Config"}
})

-- Tower Tab
local TowerTab = Window:CreateTab("üè∞ Tower", nil)
TowerTab:CreateToggle({Name="Auto Tower Join", CurrentValue=false, Flag="AutoTowerJoin", Callback=function(v) autoTowerEnabled=v end})
TowerTab:CreateToggle({Name="Auto Leave Tower", CurrentValue=false, Flag="AutoLeaveTower", Callback=function(v) autoLeaveEnabled=v end})
TowerTab:CreateSlider({Name="Leave Wave", Range={1,50}, Increment=1, Suffix="Wave", CurrentValue=leaveTowerWave, Flag="LeaveTowerWaveSlider", Callback=function(v) leaveTowerWave=v end})

-- Trial Tab
local TrialTab = Window:CreateTab("üî• Trial", nil)
TrialTab:CreateToggle({Name="Auto Trial Join", CurrentValue=false, Flag="AutoTrialJoin", Callback=function(v) autoTrialEnabled=v end})
TrialTab:CreateToggle({Name="Auto Leave Trial", CurrentValue=false, Flag="AutoLeaveTrial", Callback=function(v) autoLeaveEnabled=v end})
TrialTab:CreateSlider({Name="Leave Wave", Range={1,50}, Increment=1, Suffix="Wave", CurrentValue=leaveTrialWave, Flag="LeaveTrialWaveSlider", Callback=function(v) leaveTrialWave=v end})

-- Stars Tab
local StarsTab = Window:CreateTab("‚≠ê Stars", nil)
StarsTab:CreateToggle({Name="Auto Star Spin", CurrentValue=false, Flag="AutoStarSpin", Callback=function(v) spinEnabled=v end})

-- Rejoin Tab
local RejoinTab = Window:CreateTab("üîÑ Rejoin", nil)
RejoinTab:CreateButton({Name="Rejoin Current Server", Callback=function()
    TeleportService:Teleport(game.PlaceId, player)
end})
